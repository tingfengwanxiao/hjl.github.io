I"»•<ul id="markdown-toc">
  <li><a href="#channelæœºåˆ¶" id="markdown-toc-channelæœºåˆ¶">Channelæœºåˆ¶</a>    <ul>
      <li><a href="#æ–°å»ºæ‰“å¼€ä¸€ä¸ªchannel" id="markdown-toc-æ–°å»ºæ‰“å¼€ä¸€ä¸ªchannel">ï¼ˆæ–°å»ºï¼‰æ‰“å¼€ä¸€ä¸ªChannel</a></li>
      <li><a href="#ä¼ è¾“æ•°æ®" id="markdown-toc-ä¼ è¾“æ•°æ®">ä¼ è¾“æ•°æ®</a></li>
      <li><a href="#å…³é—­channel" id="markdown-toc-å…³é—­channel">å…³é—­Channel</a></li>
      <li><a href="#æ˜ç¡®channelä¿¡æ¯è¯·æ±‚" id="markdown-toc-æ˜ç¡®channelä¿¡æ¯è¯·æ±‚">æ˜ç¡®Channelä¿¡æ¯è¯·æ±‚</a></li>
    </ul>
  </li>
  <li><a href="#äº¤äº’session" id="markdown-toc-äº¤äº’session">äº¤äº’Session</a>    <ul>
      <li><a href="#æ‰“å¼€session-channel" id="markdown-toc-æ‰“å¼€session-channel">æ‰“å¼€Session Channel</a></li>
      <li><a href="#è¯·æ±‚ä¸€ä¸ªè™šæ‹Ÿç»ˆç«¯" id="markdown-toc-è¯·æ±‚ä¸€ä¸ªè™šæ‹Ÿç»ˆç«¯">è¯·æ±‚ä¸€ä¸ªè™šæ‹Ÿç»ˆç«¯</a></li>
      <li><a href="#x11è½¬å‘" id="markdown-toc-x11è½¬å‘">X11è½¬å‘</a></li>
      <li><a href="#ä¼ é€’ç¯å¢ƒå˜é‡" id="markdown-toc-ä¼ é€’ç¯å¢ƒå˜é‡">ä¼ é€’ç¯å¢ƒå˜é‡</a></li>
      <li><a href="#å¯åŠ¨ä¸€ä¸ªshellæˆ–è€…ä¸€ä¸ªå‘½ä»¤" id="markdown-toc-å¯åŠ¨ä¸€ä¸ªshellæˆ–è€…ä¸€ä¸ªå‘½ä»¤">å¯åŠ¨ä¸€ä¸ªShellæˆ–è€…ä¸€ä¸ªå‘½ä»¤</a></li>
      <li><a href="#çª—å£è°ƒæ•´æ¶ˆæ¯" id="markdown-toc-çª—å£è°ƒæ•´æ¶ˆæ¯">çª—å£è°ƒæ•´æ¶ˆæ¯</a></li>
      <li><a href="#æœ¬åœ°æµæ§" id="markdown-toc-æœ¬åœ°æµæ§">æœ¬åœ°æµæ§</a></li>
      <li><a href="#ä¿¡å·" id="markdown-toc-ä¿¡å·">ä¿¡å·</a></li>
      <li><a href="#è¿”å›é€€å‡ºçŠ¶æ€" id="markdown-toc-è¿”å›é€€å‡ºçŠ¶æ€">è¿”å›é€€å‡ºçŠ¶æ€</a></li>
    </ul>
  </li>
  <li><a href="#tcpip-ç«¯å£è½¬å‘" id="markdown-toc-tcpip-ç«¯å£è½¬å‘">TCP/IP ç«¯å£è½¬å‘</a>    <ul>
      <li><a href="#å…¨å±€è¯·æ±‚" id="markdown-toc-å…¨å±€è¯·æ±‚">å…¨å±€è¯·æ±‚</a></li>
      <li><a href="#è¯·æ±‚ç«¯å£è½¬å‘" id="markdown-toc-è¯·æ±‚ç«¯å£è½¬å‘">è¯·æ±‚ç«¯å£è½¬å‘</a></li>
      <li><a href="#tcpipè½¬å‘channel" id="markdown-toc-tcpipè½¬å‘channel">TCP/IPè½¬å‘Channel</a></li>
    </ul>
  </li>
  <li><a href="#ç»ˆç«¯æ¨¡å¼çš„ç¼–ç " id="markdown-toc-ç»ˆç«¯æ¨¡å¼çš„ç¼–ç ">ç»ˆç«¯æ¨¡å¼çš„ç¼–ç </a></li>
  <li><a href="#é¢„å®šä¹‰åç§°" id="markdown-toc-é¢„å®šä¹‰åç§°">é¢„å®šä¹‰åç§°</a>    <ul>
      <li><a href="#è¿æ¥åè®®channelç±»å‹" id="markdown-toc-è¿æ¥åè®®channelç±»å‹">è¿æ¥åè®®Channelç±»å‹</a></li>
      <li><a href="#è¿æ¥åè®®å…¨å±€è¯·æ±‚å" id="markdown-toc-è¿æ¥åè®®å…¨å±€è¯·æ±‚å">è¿æ¥åè®®å…¨å±€è¯·æ±‚å</a></li>
      <li><a href="#è¿æ¥åè®®channelæ˜ç»†è¯·æ±‚å" id="markdown-toc-è¿æ¥åè®®channelæ˜ç»†è¯·æ±‚å">è¿æ¥åè®®Channelæ˜ç»†è¯·æ±‚å</a></li>
      <li><a href="#è¿æ¥åè®®å­ç³»ç»Ÿå" id="markdown-toc-è¿æ¥åè®®å­ç³»ç»Ÿå">è¿æ¥åè®®å­ç³»ç»Ÿå</a></li>
    </ul>
  </li>
  <li><a href="#reference" id="markdown-toc-reference">Reference</a></li>
</ul>
<div style="text-align: center;"><img style="height:;width:;" alt="" title="" src="https://ss.caihuashuai.com/StaticData/Blog/SSH/SSH_logo.png" /></div>

<p>åœ¨è®¤è¯å®Œæ¯•åï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´å°†ä½¿ç”¨SSHè¿æ¥åè®®è¿›è¡Œå®é™…çš„ä»»åŠ¡æ“ä½œï¼ŒåŒ…æ‹¬<strong>å¼€å¯äº¤äº’å¼çš„ç™»å½•ä¼šè¯</strong>ã€<strong>è¿œç¨‹å‘½ä»¤è°ƒç”¨</strong>ã€<strong>TCPè½¬å‘</strong>ã€<strong>X11è½¬å‘</strong>ç­‰ã€‚åœ¨ä¼ è¾“å±‚åè®®ä¹‹ä¸Šï¼Œå¯ç”¨è¿æ¥åè®®çš„æ–¹å¼å°±æ˜¯è¯·æ±‚ä¸€ä¸ª<strong>service name</strong>ä¸º<strong>ssh-connection</strong>æœåŠ¡ã€‚</p>

<hr />

<h2 id="channelæœºåˆ¶">Channelæœºåˆ¶</h2>

<p>è¿æ¥åè®®é‡Œçš„æ¯ä¸ªå®é™…åº”ç”¨éƒ½æ˜¯Channelï¼Œå„æ–¹éƒ½æœ‰å¯èƒ½æ‰“å¼€Channelï¼Œå¤§é‡çš„Channelå¤ç”¨åŒä¸€ä¸ªConnectionï¼ˆæˆ‘è®¤ä¸ºè¿™é‡ŒæŒ‡çš„Connectionåº”è¯¥æ˜¯ä¸Šæ–‡è¯´çš„ssh-connection serviceï¼‰ã€‚ä¸€ä¸ªChannelè¢«åŒæ–¹ç”¨è‡ªå·±çš„æ•°å­—æ ‡è¯†ï¼Œæ‰€ä»¥æ¯ç«¯ä¸åŒçš„æ•°å­—å¯èƒ½æŒ‡å‘çš„å¹¶ä¸æ˜¯ç›¸åŒçš„Channelã€‚å…¶ä»–ä»»ä½•å’ŒChannelç›¸å…³çš„æ¶ˆæ¯éƒ½ä¼šåŒ…å«å¯¹ç«¯çš„Channelæ ‡è¯†ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sender:number1    -&gt;    ()=========================()    &lt;-    number2:receiver
</code></pre></div></div>
<p>Channelæ˜¯è¢«<code class="language-plaintext highlighter-rouge">æµæ§</code>çš„ï¼Œåœ¨è¢«å‘ŠçŸ¥<code class="language-plaintext highlighter-rouge">çª—å£</code>å¯ç”¨ä¹‹å‰æ²¡æœ‰æ•°æ®å¯ä»¥åœ¨Channelé‡Œä¼ è¾“ã€‚</p>

<h3 id="æ–°å»ºæ‰“å¼€ä¸€ä¸ªchannel">ï¼ˆæ–°å»ºï¼‰æ‰“å¼€ä¸€ä¸ªChannel</h3>

<p>å½“ä»»æ„ä¸€ç«¯æƒ³è¦æ–°å»ºä¸€ä¸ªChannelæ—¶ï¼Œå®ƒé¦–å…ˆè¦ç»™Channelåˆ†é…ä¸€ä¸ªæœ¬ç«¯çš„æ•°å­—æ ‡è¯†ã€‚ç„¶åå°†ä¸‹é¢çš„æ¶ˆæ¯å‘é€ç»™å¯¹ç«¯ï¼Œè¿™ä¸ªæ¶ˆæ¯åŒ…æ‹¬äº†æœ¬ï¼ˆå‘é€ï¼‰ç«¯æ ‡è¯†ã€åˆå§‹åŒ–çª—å£å¤§å°ç­‰ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_CHANNEL_OPEN
      string    channel type in US-ASCII only
      uint32    sender channel
      uint32    initial window size
      uint32    maximum packet size
      ....      channel type specific data follows
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">channel type</code>æ˜¯ä¸€ä¸ªåå­—ï¼Œç¬¦åˆSSH rfcå‘½åè§„èŒƒï¼Œæ³¨å†Œå‘½å(<code class="language-plaintext highlighter-rouge">åç§°</code>)ã€æ‰©å±•å‘½åï¼ˆ<code class="language-plaintext highlighter-rouge">åç§°@åŸŸå</code>ï¼‰ï¼›<code class="language-plaintext highlighter-rouge">sender channel</code>æ˜¯æœ¬åœ°çš„æ ‡è¯†ï¼›<code class="language-plaintext highlighter-rouge">initial window size</code>åˆ™æ˜ç¡®äº†<strong>åœ¨ä¸è°ƒæ•´çª—å£å¤§å°çš„æƒ…å†µä¸‹ï¼Œå¯¹æ–¹ä¸€å…±å¯ä»¥å‘é€å¤šå°‘å­—èŠ‚çš„æ•°æ®ç»™ï¼ˆè¿™ä¸ªæ¶ˆæ¯çš„ï¼‰å‘é€è€…</strong>ï¼›<code class="language-plaintext highlighter-rouge">maximum packet size</code>è¡¨ç¤ºå¯¹æ–¹å‘ç»™ <strong>(è¿™ä¸ªæ¶ˆæ¯çš„)å‘é€è€…</strong> çš„å•æ¬¡çš„packetçš„æœ€å¤§å€¼æ˜¯å¤šå°‘ã€‚</p>

<p><strong>ä¸ºä»€ä¹ˆè¦è®¾ç½®window sizeå’Œmaximum packet size</strong>ï¼Œæˆ‘çš„ç†è§£æ˜¯ï¼Œæœ‰ä¸€äº›è€æ—§çš„æ…¢é€Ÿè®¾å¤‡IOå¸¦å®½å¾ˆä½ï¼Œæ‰€ä»¥å¦‚æœå¤§é‡çš„æ•°æ®æ¶Œè¿›æ¥ä¼šå¯¼è‡´ç¼“å†²åŒºæº¢å‡ºã€‚</p>

<p>å¯¹ç«¯æ”¶åˆ°æ¶ˆæ¯åéœ€è¦ä½œå‡ºå†³å®šæ˜¯å¦åŒæ„å¼€å¯ä¸€ä¸ªChannelï¼Œä½¿ç”¨SSH_MSG_CHANNEL_OPEN_CONFIRMATIONæˆ–SSH_MSG_CHANNEL_OPEN_FAILUREå“åº”æ¶ˆæ¯ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_CHANNEL_OPEN_CONFIRMATION
      uint32    recipient channel
      uint32    sender channel
      uint32    initial window size
      uint32    maximum packet size
      ....      channel type specific data follows
</code></pre></div></div>
<p>å…¶ä¸­<code class="language-plaintext highlighter-rouge">recipient channel</code>ä¸º<strong>è¯·æ±‚å¼€å¯Channelç«¯</strong>çš„æœ¬åœ°Channelæ ‡è¯†ï¼Œ<code class="language-plaintext highlighter-rouge">sender channel</code>åˆ™ä¸º<strong>å½“å‰æ¶ˆæ¯å‘é€æ–¹</strong>çš„æœ¬åœ°Channelæ ‡è¯†ï¼Œå…¶ä»–çš„æ•°æ®éƒ½æ˜¯æè¿°<strong>å½“å‰æ¶ˆæ¯å‘é€æ–¹</strong>çš„ã€‚æˆ–è€…å‘é€æ‰“å¼€å¤±è´¥çš„æ¶ˆæ¯SSH_MSG_CHANNEL_OPEN_FAILUREã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_CHANNEL_OPEN_FAILURE
      uint32    recipient channel
      uint32    reason code
      string    description in ISO-10646 UTF-8 encoding [RFC3629]
      string    language tag [RFC3066]
</code></pre></div></div>
<p>æ¯”å¦‚<strong>è¢«è¯·æ±‚å¼€å¯Channelçš„ä¸€æ–¹</strong>ä¸æ”¯æŒæ ‡æ³¨çš„<code class="language-plaintext highlighter-rouge">channel type</code>ï¼Œé‚£å®ƒå°†ç®€å•åœ°å›åº”SSH_MSG_CHANNEL_OPEN_FAILUREã€‚è¯·æ±‚æ–¹åˆ™æˆ–è®¸éœ€è¦æ˜¾ç¤º<code class="language-plaintext highlighter-rouge">description</code>ç»™ç”¨æˆ·ã€‚ä¸‹é¢æ˜¯ä¸€äº›é¢„å®šä¹‰çš„é”™è¯¯ç ï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            SSH_OPEN_ADMINISTRATIVELY_PROHIBITED          1
            SSH_OPEN_CONNECT_FAILED                       2
            SSH_OPEN_UNKNOWN_CHANNEL_TYPE                 3
            SSH_OPEN_RESOURCE_SHORTAGE                    4
</code></pre></div></div>
<p>é”™è¯¯ç 0x00000005 - 0xFDFFFFFFå°†æŒ‰ç…§<code class="language-plaintext highlighter-rouge">IETF CONSENSUS</code>çš„æ–¹å¼åˆ†é…ï¼Œ0xFE000000 - 0xFFFFFFFFåˆ™ç•™ç»™ä¸ªäººä½¿ç”¨ã€‚è™½ç„¶IANAæ²¡æœ‰å…³äº0xFE000000 - 0xFFFFFFFFçš„æ§åˆ¶æƒï¼Œä½†æ˜¯è¿˜æ˜¯å°†ä»–çº¦å®šæˆ2éƒ¨åˆ†ä½¿ç”¨ï¼š</p>

<ul>
  <li>
    <p>0xFE000000 - 0xFEFFFFFFè¢«ç”¨åœ¨æœ¬åœ°åˆ†é…çš„Channelä¸Šï¼Œæ¯”å¦‚channel typeä¸ºâ€example_session@example.comâ€(å¸¦æœ‰@ç¬¦å·)çš„Channelæ‰“å¼€å¤±è´¥ï¼Œé‚£ä¹ˆé”™è¯¯ç åº”è¯¥ä½¿ç”¨ç”±IANAåˆ†é…çš„éƒ¨åˆ†ï¼ˆ 0x00000001 - 0xFDFFFFFFï¼‰æˆ–è€…æœ¬åœ°åˆ†é…ç›¸å…³çš„éƒ¨åˆ†ï¼ˆ0xFE000000 - 0xFEFFFFFFï¼‰ã€‚</p>

    <p>æ¯”å¦‚æœåŠ¡å™¨ä¸è®¤è¯†è¿™ä¸ªchannel typeï¼Œå“ªæ€•è¿™ä¸ªtypeæ˜¯æœ¬åœ°å®šä¹‰ï¼ˆåŒ…å«@ï¼‰çš„ï¼Œä¹Ÿå¿…é¡»ä½¿ç”¨0x00000003é”™è¯¯ç ã€‚ç„¶è€Œå¦‚æœï¼ŒæœåŠ¡å™¨è®¤è¯†è¿™ä¸ªé”™è¯¯ç ä½†æ˜¯æ— æ³•æ‰“å¼€ï¼Œåˆ™åº”è¯¥ä½¿ç”¨0xFE000000 - 0xFEFFFFFFå…¶ä¸­çš„ä¸€ä¸ªé”™è¯¯ç ã€‚æ€»çš„æ¥è¯´ï¼Œå‚ä¸è€…åº”è¯¥é¦–å…ˆå°è¯•ä½¿ç”¨IANAåˆ†é…çš„é”™è¯¯ç ï¼Œç„¶ååœ¨ä½¿ç”¨å®ƒä»¬è‡ªå®šä¹‰çš„åŸå› ã€‚</p>
  </li>
  <li>
    <p>å¯¹äºä»0xFFå¼€å§‹çš„éƒ¨åˆ†ï¼Œä¸åšé™åˆ¶æˆ–å»ºè®®ã€‚åœ¨è¿™ä¸ªèŒƒå›´å†…çš„æ¯ä¸€ä¸ªå€¼ï¼Œéƒ½ä¸è¢«æœŸæœ›æœ‰ä»»ä½•å®é™…æ“ä½œäº¤äº’æ€§ï¼Œæœ¬è´¨ä¸Šè¯´å®ƒä»¬æ˜¯ä¸ºå®éªŒç›®çš„è€Œé¢„ç•™çš„ã€‚</p>
  </li>
</ul>

<h3 id="ä¼ è¾“æ•°æ®">ä¼ è¾“æ•°æ®</h3>

<p>ä¸Šæ–‡æè¿°äº†çª—å£å¤§å°å¯ä»¥ç”¨æ¥é™åˆ¶å¦ä¸€æ–¹å‘é€çš„æ•°æ®é‡ï¼ŒåŒæ—¶åè®®è§„å®šåŒæ–¹éƒ½å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ¶ˆæ¯å¯¹çª—å£ä½œå‡ºè°ƒæ•´ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_CHANNEL_WINDOW_ADJUST
      uint32    recipient channel
      uint32    bytes to add
</code></pre></div></div>
<p>æ¥æ”¶æ–¹æ¥æ”¶åˆ°è¿™ä¸ªæ¶ˆæ¯ä»¥åï¼Œæ¥æ”¶æ–¹å¯ä»¥æ ¹æ®è¿™ä¸ªç»™å®šçš„æ•°å¢åŠ çª—å£çš„å¤§å°ï¼Œä¸è®ºå¦‚ä½•çª—å£æœ€å¤§ä¸º2^32-1å­—èŠ‚ã€‚å…·ä½“çš„æ•°æ®ï¼Œåˆ™é€šè¿‡ä¸‹é¢çš„æ¶ˆæ¯å‘é€ã€‚</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_CHANNEL_DATA
      uint32    recipient channel
      string    data
</code></pre></div></div>
<p>å•æ¬¡å¯ä»¥å‘é€æ•°æ®çš„æœ€å¤§é‡å–å†³äº<strong>å¯¹æ–¹å½“å‰çª—å£å°ºå¯¸</strong>å’Œ<strong>å¯¹æ–¹å…è®¸æ¥å—çš„æœ€å¤§packetå€¼</strong>çš„æœ€å°å€¼ã€‚å¯¹æ–¹æ¯æ¥å—ä¸€ä¸ªæ¶ˆæ¯ï¼Œçª—å£éƒ½ä¼šç›¸åº”å‡å°‘ã€‚è§„èŒƒæœŸæœ›å®ç°å¯ä»¥å¯¹ä¼ è¾“å±‚packet sizeåšå‡ºé™åˆ¶ï¼ˆä»»ä½•å…³äºæ¥å—æ•°æ®çš„é™åˆ¶å¿…é¡»å¤§äºç­‰äº32768å­—èŠ‚ï¼‰ã€‚æ‰€ä»¥åœ¨è¿æ¥å±‚åè®®ï¼š</p>

<ul>
  <li>
    <p>ä¸å‡†å°†å¯æ¥å—çš„maximum packet sizeè®¾ç½®æˆå¤§äºä¼ è¾“å±‚èƒ½æ¥å—çš„æœ€å¤§å€¼ã€‚</p>
  </li>
  <li>
    <p>ä¸å‡†ç”Ÿæˆè¶…è¿‡ä¼ è¾“å±‚èƒ½å‘é€çš„æœ€å¤§å€¼ï¼Œå“ªæ€•å¯¹æ–¹çš„è¿æ¥åè®®èƒ½æ¥å—è¿™ä¹ˆå¤§çš„packetã€‚</p>
  </li>
</ul>

<p>åŒæ—¶ï¼Œåè®®æä¾›äº†ä¸€äº›ä¼ é€’é¢å¤–æ•°æ®ï¼ˆæ¯”å¦‚stderræ•°æ®ï¼‰çš„æ–¹æ³•ã€‚</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_CHANNEL_EXTENDED_DATA
      uint32    recipient channel
      uint32    data_type_code
      string    data
</code></pre></div></div>
<p>ç›®å‰æ ‡å‡†å®šä¹‰çš„data_type_codeç±»å‹æœ‰ï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>             SSH_EXTENDED_DATA_STDERR               1
</code></pre></div></div>
<p>åŒæ—¶è¿™ä¸ªdata_type_codeçš„å€¼çš„åˆ†å‘è§„å®šä¹Ÿä¸ä¸Šæ–‡çš„channel typeç±»ä¼¼ï¼Œåˆ†ä¸ºIANAéƒ¨åˆ†å’Œç§äººä½¿ç”¨éƒ¨åˆ†ã€‚</p>

<h3 id="å…³é—­channel">å…³é—­Channel</h3>

<p>å½“ä»»æ„ä¸€æ–¹ä¸åœ¨å¾€Channelå‘é€æ›´å¤šæ•°æ®çš„æ—¶å€™ï¼Œå®ƒåº”è¯¥å‘é€ä¸€ä¸ªSSH_MSG_CHANNEL_EOFæ¶ˆæ¯ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_CHANNEL_EOF
      uint32    recipient channel
</code></pre></div></div>

<p>è¿™ä¸ªæ¶ˆæ¯ä¸ä¼šæœ‰æ˜ç¡®çš„å“åº”ï¼Œä½†æ˜¯å®ƒä¾æ—§åº”è¯¥è¢«å‘é€ç»™å¯¹æ–¹ä¸è®ºå¯¹æ–¹æ˜¯è°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå‘é€å®Œè¿™ä¸ªæ¶ˆæ¯åï¼ŒChannelä¾æ—§æ˜¯æ‰“å¼€ç€çš„ï¼ˆåªä¸è¿‡è‡ªå·±è¿™ä¸€è¾¹ä¸å†å‘æ•°æ®äº†ï¼‰ï¼Œä»å¦ä¸€ä¸ªæ–¹å‘ä¸Šè¿˜æ˜¯å¯èƒ½è¿‡æ¥æ›´å¤šçš„æ•°æ®ã€‚è¿™ä¸ªæ¶ˆæ¯å¹¶ä¸ä¼šæ¶ˆè€—çª—å£å¤§å°ï¼Œå³ä½¿çª—å£å·²ç»ä¸å¯ä»¥ã€‚</p>

<p>å½“ä»»æ„ä¸€æ–¹å¸Œæœ›ç»“æŸChannelæ—¶ï¼Œåˆ™åº”è¯¥å‘é€SSH_MSG_CHANNEL_CLOSEã€‚å¦ä¸€æ–¹å¿…é¡»ä¹Ÿå‘é€SSH_MSG_CHANNEL_CLOSEï¼Œé™¤éå®ƒå·²ç»å‘é€è¿‡SSH_MSG_CHANNEL_CLOSEï¼ˆç½‘ç»œå»¶è¿Ÿï¼‰äº†ã€‚å½“ä¸€æ–¹<strong>æ—¢å‘é€äº†åˆæ¥æ”¶åˆ°</strong>SSH_MSG_CHANNEL_CLOSEæ¶ˆæ¯ï¼ŒChannelå°±è¢«å…³é—­äº†ï¼Œç›¸å…³çš„èµ„æºå¯ä»¥è¢«æ¸…ç†ï¼Œæœ¬åœ°çš„Channel numberå¯ä»¥åœ¨ä¸‹æ¬¡æ‰“å¼€Channelçš„æ—¶å€™é‡ç”¨ã€‚ä»»æ„ä¸€æ–¹éƒ½å¯ä»¥ç›´æ¥å‘é€SSH_MSG_CHANNEL_CLOSEè€Œä¸éœ€è¦ä¸ç°å‘é€SSH_MSG_CHANNEL_EOFã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_CHANNEL_CLOSE
      uint32    recipient channel
</code></pre></div></div>
<p>åŒæ ·çš„ï¼Œè¿™ä¸ªæ¶ˆæ¯ä¸éœ€è¦æ¶ˆè€—çª—å£å¤§å°ã€‚</p>

<h3 id="æ˜ç¡®channelä¿¡æ¯è¯·æ±‚">æ˜ç¡®Channelä¿¡æ¯è¯·æ±‚</h3>

<p>è®¸å¤šçš„channel typeåŒ…å«å…³äºè¯¥channel typeçš„æ›´è¯¦ç»†çš„æ‰©å……è®¾å®šã€‚æ¯”å¦‚è¯´ï¼Œä¸ºä¸€ä¸ªäº¤äº’sessionè¯·æ±‚ä¸€ä¸ªè™šæ‹Ÿç»ˆç«¯ã€‚æ‰€æœ‰çš„æ˜ç¡®Channelä¿¡æ¯è¯·æ±‚éƒ½æ˜¯å¦‚ä¸‹æ ¼å¼ã€‚</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_CHANNEL_REQUEST
      uint32    recipient channel
      string    request type in US-ASCII characters only
      boolean   want reply
      ....      type-specific data follows
</code></pre></div></div>
<p>å¦‚æœ<code class="language-plaintext highlighter-rouge">want reply</code>è¢«è®¾ç½®æˆFALSEï¼Œä¸ä¼šæœ‰å“åº”è¢«å›å¤ç»™è¯·æ±‚ç«¯ã€‚å¦åˆ™ï¼Œå“åº”å¯èƒ½åŒ…æ‹¬SSH_MSG_CHANNEL_SUCCESSã€SSH_MSG_CHANNEL_FAILUREæˆ–è€…è¦æ±‚ç»§ç»­æä¾›ä¿¡æ¯çš„æ¶ˆæ¯ã€‚å¦‚æœæ¥æ”¶ç«¯ä¸è®¤è¯†æˆ–ä¸æ”¯æŒè¿™ä¸ªæ‰©å……çš„æ˜ç»†ï¼Œåˆ™è¿”å›SSH_MSG_CHANNEL_FAILUREã€‚</p>

<p>è¿™ä¸ªæ¶ˆæ¯ä¹Ÿä¸æ¶ˆè€—çª—å£å¤§å°ï¼Œ<code class="language-plaintext highlighter-rouge">request type</code>æ˜¯è‡ªå®šä¹‰çš„ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_CHANNEL_SUCCESS
      uint32    recipient channel


      byte      SSH_MSG_CHANNEL_FAILURE
      uint32    recipient channel
</code></pre></div></div>
<p>ä¸Šè¿°ä¸¤ä¸ªæ¶ˆæ¯ä¹Ÿä¸æ¶ˆè€—çª—å£å¤§å°ã€‚</p>

<h2 id="äº¤äº’session">äº¤äº’Session</h2>

<p><strong>ä¸€ä¸ªSessionå°±æ˜¯ä¸€ä¸ªè¿œç¨‹çš„ç¨‹åºçš„æ‰§è¡Œ</strong>ã€‚è¿™ä¸ªç¨‹åºæˆ–è®¸æ˜¯shellã€åº”ç”¨ç¨‹åºã€ç³»ç»Ÿè°ƒç”¨æˆ–è€…å†…å»ºçš„å­ç³»ç»Ÿã€‚å®ƒå¯èƒ½æ²¡æœ‰ç»‘å®šåˆ°è™šæ‹Ÿç»ˆç«¯ä¸Šï¼Œåˆæˆ–è€…æœ‰æˆ–æ²¡æœ‰æ¶‰åŠåˆ°X11è½¬å‘ã€‚åŒæ—¶é—´ï¼Œå¯ä»¥æœ‰å¤šä¸ªSessionæ­£åœ¨è¢«è¿è¡Œã€‚</p>

<h3 id="æ‰“å¼€session-channel">æ‰“å¼€Session Channel</h3>

<p>ä½¿ç”¨å¦‚ä¸‹æ¶ˆæ¯æ‰“å¼€ä¸€ä¸ªSession Channelï¼Œå®¢æˆ·ç«¯åº”è¯¥æ‹’ç»æ¥è‡ªæœåŠ¡ç«¯çš„æ‰“å¼€Session Channelçš„è¯·æ±‚ä»¥é¿å…è¢«æ”»å‡»ã€‚</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_CHANNEL_OPEN
      string    "session"
      uint32    sender channel
      uint32    initial window size
      uint32    maximum packet size
</code></pre></div></div>

<h3 id="è¯·æ±‚ä¸€ä¸ªè™šæ‹Ÿç»ˆç«¯">è¯·æ±‚ä¸€ä¸ªè™šæ‹Ÿç»ˆç«¯</h3>

<p>é€šè¿‡å¦‚ä¸‹æ¶ˆæ¯å¯ä»¥è®©æœåŠ¡å™¨ä¸ºSessionåˆ†é…ä¸€ä¸ªè™šæ‹Ÿç»ˆç«¯ï¼Œcharacter/rowçš„ä¼˜å…ˆçº§ç›¸æ¯”äºpixelsæ›´é«˜ï¼Œé™¤éä»–ä»¬è¢«è®¾ç½®æˆ0ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_CHANNEL_REQUEST
      uint32    recipient channel
      string    "pty-req"
      boolean   want_reply
      string    TERM environment variable value (e.g., vt100)
      uint32    terminal width, characters (e.g., 80)
      uint32    terminal height, rows (e.g., 24)
      uint32    terminal width, pixels (e.g., 640)
      uint32    terminal height, pixels (e.g., 480)
      string    encoded terminal modes
</code></pre></div></div>
<p>å®¢æˆ·ç«¯åº”è¯¥æ‹’ç»æ¥è‡ªæœåŠ¡ç«¯çš„è™šæ‹Ÿç»ˆç«¯æ˜ç¡®ä¿¡æ¯è¯·æ±‚ä»¥é¿å…è¢«æ”»å‡»ã€‚</p>

<h3 id="x11è½¬å‘">X11è½¬å‘</h3>

<p>é€šè¿‡å¦‚ä¸‹æ¶ˆæ¯å¯ä»¥ä¸ºSessionè¯·æ±‚X11è½¬å‘ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_CHANNEL_REQUEST
      uint32    recipient channel
      string    "x11-req"
      boolean   want reply
      boolean   single connection
      string    x11 authentication protocol
      string    x11 authentication cookie
      uint32    x11 screen number
</code></pre></div></div>
<p>åè®®æ¨èå°†<code class="language-plaintext highlighter-rouge">x11 authentication cookie</code>å‘é€æˆä¸€ä¸ªè™šå‡ä¸”éšæœºçš„cookieï¼ŒçŸ¥é“è¿æ¥æ¶ˆæ¯è¢«æ¥æ”¶åå®ƒå°†è¢«æ£€éªŒå¹¶æ›¿æ¢æˆçœŸå®çš„cookieã€‚å½“session channelè¢«å…³é—­çš„æ—¶å€™ï¼ŒX11è½¬å‘ä¹Ÿåº”è¯¥åœæ­¢ï¼Œä½†æ˜¯å·²ç»æ‰“å¼€çš„è½¬å‘ä¸åº”è¯¥è‡ªåŠ¨è¢«å…³é—­ã€‚å¦‚æœ<code class="language-plaintext highlighter-rouge">single connection</code>è¢«è®¾ç½®ä¸ºTRUEï¼Œé‚£ä¹ˆåªæœ‰ä¸€ä¸ªè¿æ¥è¢«è½¬å‘ã€‚</p>

<p>è¿™ä¸ªæ¶ˆæ¯å¯¹åº”çš„æ“ä½œæ˜¯ï¼š å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼ŒæœåŠ¡å™¨åœ¨æœ¬åœ°æ–°å»ºNä¸ªï¼ˆå¦‚æœsingle connectionä¸ä¸º0ï¼‰X11æœåŠ¡å™¨ï¼ˆåªæ˜¯çº¯ç²¹çš„ç›‘å¬6000+serverè‡ªå®šä¹‰offsetï¼ˆopensshä¸º10ï¼‰çš„TCPç«¯å£ï¼Œåˆ›å»ºç›¸åº”çš„DISPLAYç¯å¢ƒå˜é‡ï¼‰ã€‚</p>

<p>åœ¨remote sessionä¸Šæ‰§è¡Œ<code class="language-plaintext highlighter-rouge">gedit &amp;</code>æ—¶ï¼Œ<code class="language-plaintext highlighter-rouge">gedit</code>æ˜¯ç¬¦åˆX11åè®®çš„å®¢æˆ·ç«¯ï¼Œæ‰€ä»¥å®ƒä¼šæ£€æµ‹ç¯å¢ƒå˜é‡å‘ç°å­˜åœ¨displayï¼Œå°±å’Œæœ¬åœ°çš„6010ç«¯å£å»ºç«‹è¿æ¥ã€‚æœåŠ¡å™¨çš„ä¼ªx11æœåŠ¡å™¨socketä¾¦æµ‹åˆ°è¿æ¥å°±å¾ˆå‘å®¢æˆ·ç«¯å‘èµ·SSH_MSG_CHANNEL_OPEN x11 Channelçš„è¯·æ±‚ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_CHANNEL_OPEN
      string    "x11"
      uint32    sender channel
      uint32    initial window size
      uint32    maximum packet size
      string    originator address (e.g., "192.168.7.38")
      uint32    originator port
</code></pre></div></div>
<p>å®¢æˆ·ç«¯æ”¶åˆ°è¯·æ±‚åå†ä¸æœ¬åœ°çš„X11å»ºç«‹è¿æ¥ï¼Œè¿™æ ·ä¸€ä¸ªX11è½¬å‘çš„é€šé“å°±å®Œæˆäº†ï¼ˆæˆ‘å¹¶æ²¡æœ‰åœ¨opensshçš„æºç ä¸­å‘ç°å®¢æˆ·ç«¯æ˜¯å¦‚ä½•ä½¿ç”¨originator addressæ•°æ®çš„ï¼‰ã€‚</p>

<h3 id="ä¼ é€’ç¯å¢ƒå˜é‡">ä¼ é€’ç¯å¢ƒå˜é‡</h3>

<p>åœ¨shellæˆ–commandè¢«å¼€å§‹æ—¶ä¹‹åï¼Œæˆ–è®¸æœ‰ç¯å¢ƒå˜é‡éœ€è¦è¢«ä¼ é€’è¿‡å»ã€‚ç„¶è€Œåœ¨ç‰¹æƒç¨‹åºé‡Œä¸å—æ§åˆ¶çš„è®¾ç½®ç¯å¢ƒå˜é‡æ˜¯ä¸€ä¸ªå¾ˆæœ‰é£é™©çš„äº‹æƒ…ï¼Œæ‰€ä»¥è§„èŒƒæ¨èå®ç°ç»´æŠ¤ä¸€ä¸ªå…è®¸è¢«è®¾ç½®çš„ç¯å¢ƒå˜é‡åˆ—è¡¨æˆ–è€…åªæœ‰å½“sshdä¸¢å¼ƒæƒé™åè®¾ç½®ç¯å¢ƒå˜é‡ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_CHANNEL_REQUEST
      uint32    recipient channel
      string    "env"
      boolean   want reply
      string    variable name
      string    variable value
</code></pre></div></div>

<h3 id="å¯åŠ¨ä¸€ä¸ªshellæˆ–è€…ä¸€ä¸ªå‘½ä»¤">å¯åŠ¨ä¸€ä¸ªShellæˆ–è€…ä¸€ä¸ªå‘½ä»¤</h3>

<p>ä¸€æ—¦ä¸€ä¸ªSessionè¢«è®¾ç½®å®Œæ¯•ï¼Œåœ¨è¿œç«¯å°±ä¼šæœ‰ä¸€ä¸ªç¨‹åºè¢«å¯åŠ¨ã€‚è¿™ä¸ªç¨‹åºå¯ä»¥æ˜¯ä¸€ä¸ªShellï¼Œä¹Ÿå¯ä»¥æ—¶ä¸€ä¸ªåº”ç”¨ç¨‹åºæˆ–è€…æ˜¯ä¸€ä¸ªæœ‰ç€ç‹¬ç«‹åŸŸåçš„å­ç³»ç»Ÿã€‚ä¸‹é¢çš„è¯·æ±‚æ¯ä¸ªChannelï¼ˆSessionï¼‰åªå…è®¸è®¾ç½®ä¸€ä¸ªã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_CHANNEL_REQUEST
      uint32    recipient channel
      string    "shell"
      boolean   want reply

      byte      SSH_MSG_CHANNEL_REQUEST
      uint32    recipient channel
      string    "exec"
      boolean   want reply
      string    command

      byte      SSH_MSG_CHANNEL_REQUEST
      uint32    recipient channel
      string    "subsystem"
      boolean   want reply
      string    subsystem name
</code></pre></div></div>

<h3 id="çª—å£è°ƒæ•´æ¶ˆæ¯">çª—å£è°ƒæ•´æ¶ˆæ¯</h3>

<p>å½“å®¢æˆ·ç«¯çš„ç»ˆç«¯çª—å£å¤§å°è¢«æ”¹å˜æ—¶ï¼Œæˆ–è®¸éœ€è¦å‘é€è¿™ä¸ªæ¶ˆæ¯ç»™æœåŠ¡å™¨ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_CHANNEL_REQUEST
      uint32    recipient channel
      string    "window-change"
      boolean   FALSE
      uint32    terminal width, columns
      uint32    terminal height, rows
      uint32    terminal width, pixels
      uint32    terminal height, pixels
</code></pre></div></div>
<p>è¿™ä¸ªæ¶ˆæ¯æ²¡æœ‰å“åº”ã€‚</p>

<h3 id="æœ¬åœ°æµæ§">æœ¬åœ°æµæ§</h3>

<p>åœ¨å¾ˆå¤šç³»ç»Ÿä¸­ï¼Œè¿™æ˜¯å¦å¯è¡Œå–å†³äºä¼ªç»ˆç«¯æ˜¯å¦ä½¿ç”¨<code class="language-plaintext highlighter-rouge">control-S/control-Q</code>è¿›è¡Œæµæ§ã€‚å¦‚æœæ­£åœ¨ä½¿ç”¨ï¼Œé‚£ä¹ˆåœ¨å®¢æˆ·ç«¯å°±åº”è¯¥æœ‰ä¸€ä¸ªæµæ§çš„åŠŸèƒ½ç»™æœåŠ¡ç«¯çš„å“åº”æé€Ÿï¼Œè¿™è¿˜æ˜¯å–å†³äºæœåŠ¡ç«¯è®¾å¤‡çš„ï¼ˆç³»ç»Ÿï¼‰å®ç°ã€‚ä¸‹é¢çš„æ¶ˆæ¯å¯ä»¥è®©æœåŠ¡å™¨é€šçŸ¥å®¢æˆ·ç«¯æ˜¯å¦å¯ä»¥æä¾›æµæ§çš„åŠŸèƒ½ï¼Œå¦‚æœå¯ä»¥çš„è¯å®¢æˆ·ç«¯åˆ™å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">control-S/control-Q</code>è¿›è¡Œæµæ§ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_CHANNEL_REQUEST
      uint32    recipient channel
      string    "xon-xoff"
      boolean   FALSE
      boolean   client can do
</code></pre></div></div>
<p>è¿™ä¸ªæ¶ˆæ¯æ²¡æœ‰å“åº”ã€‚</p>

<h3 id="ä¿¡å·">ä¿¡å·</h3>

<p>ä¸€ä¸ªä¿¡å·å¯ä»¥è¢«ä¼ è¾“ç»™è¿œç«¯çš„ç¨‹åºæˆ–æœåŠ¡ä½¿ç”¨ä¸‹é¢çš„æ¶ˆæ¯ã€‚æœ‰ä¸€äº›ç³»ç»Ÿå¯èƒ½æ²¡æœ‰å®ç°ä¿¡å·ï¼Œæ‰€ä»¥é‚£äº›ç³»ç»Ÿä¸‹çš„æœåŠ¡ç«¯åº”è¯¥å¿½ç•¥è¿™ä¸ªæ¶ˆæ¯ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_CHANNEL_REQUEST
      uint32    recipient channel
      string    "signal"
      boolean   FALSE
      string    signal name (without the "SIG" prefix)
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">signal name</code>åœ¨ä¸‹é¢çš„é¢„å®šä¹‰åç§°ä¸­æœ‰æè¿°ã€‚</p>

<h3 id="è¿”å›é€€å‡ºçŠ¶æ€">è¿”å›é€€å‡ºçŠ¶æ€</h3>

<p>å½“åœ¨è¿œç«¯çš„å‘½ä»¤ç»“æŸæ—¶ï¼Œä¸‹é¢çš„æ¶ˆæ¯å¯ä»¥ç”¨æ¥ä¼ é€’å…¶é€€å‡ºçš„çŠ¶æ€ç ã€‚å‘é€æˆ–æ”¶åˆ°è¿™ä¸ªæ¶ˆæ¯åChannelå°†è¢«å…³é—­ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_CHANNEL_REQUEST
      uint32    recipient channel
      string    "exit-status"
      boolean   FALSE
      uint32    exit_status
</code></pre></div></div>
<p>åŒæ—¶è¿œç«¯çš„ç¨‹åºä¹Ÿå¯èƒ½å› ä¸ºä¸€ä¸ªä¿¡å·è€Œè¢«è¿«å…³é—­(<code class="language-plaintext highlighter-rouge">exit_statue</code> ä¸º0çš„æ—¶å€™ä¸ºæ­£å¸¸å…³é—­)ï¼Œè¿™ä¸ªæƒ…å†µä¸‹ä¸‹é¢çš„æ¶ˆæ¯å°†è¢«å‘é€ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_CHANNEL_REQUEST
      uint32    recipient channel
      string    "exit-signal"
      boolean   FALSE
      string    signal name (without the "SIG" prefix)
      boolean   core dumped
      string    error message in ISO-10646 UTF-8 encoding
      string    language tag [RFC3066]
</code></pre></div></div>

<h2 id="tcpip-ç«¯å£è½¬å‘">TCP/IP ç«¯å£è½¬å‘</h2>

<h3 id="å…¨å±€è¯·æ±‚">å…¨å±€è¯·æ±‚</h3>

<p>åè®®è§„å®šäº†è®¸å¤šç§å¯ä»¥å½±å“è¿œç«¯å…¨å±€è€Œç‹¬ç«‹äºä»»ä½•Channelçš„è¯·æ±‚ï¼Œä¸€ä¸ªä¾‹å­å°±æ˜¯å”¯ä¸€ä¸ªç‰¹å®šçš„ç«¯å£è¯·æ±‚TCP/IPè½¬å‘ã€‚åŒæ–¹ä¸­çš„ä»»æ„ä¸€æ–¹éƒ½æœ‰å¯èƒ½åœ¨ä»»æ„æ—¶é—´å‘é€å…¨å±€è¯·æ±‚ï¼Œæ¥æ”¶æ–¹å¿…é¡»åšå‡ºåˆç†çš„å“åº”ï¼Œå…¶æ ¼å¼å¦‚ä¸‹ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_GLOBAL_REQUEST
      string    request name in US-ASCII only
      boolean   want reply
      ....      request-specific data follows
</code></pre></div></div>
<p>å“åº”å¦‚ä¸‹ï¼Œé€šå¸¸ä¸åŒ…å«<code class="language-plaintext highlighter-rouge">response specific data</code>è¿™ä¸€æ ã€‚</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_REQUEST_SUCCESS
      ....     response specific data
</code></pre></div></div>
<p>åè®®è§„å®šï¼ŒSSH_MSG_GLOBAL_REQUESTSçš„å“åº”é¡ºåºå¿…é¡»å¦‚å…¶å‘é€é¡ºåºä¸€è‡´ã€‚æœ‰æ˜ç¡®æŒ‡ç¤ºChannelçš„è¯·æ±‚æ¶ˆæ¯æ‰å¯ä»¥ä¸æŒ‰é¡ºåºå‘é€ã€‚</p>
<h3 id="è¯·æ±‚ç«¯å£è½¬å‘">è¯·æ±‚ç«¯å£è½¬å‘</h3>

<p>å¦‚æœå…¶ä¸­ä¸€æ–¹æœŸæœ›<strong>ä¸€ä¸ªå‘å¾€å¯¹æ–¹ç«¯å£çš„æ•°æ®å¯ä»¥è½¬å‘åˆ°æœ¬åœ°çš„ç«¯å£</strong>ï¼Œé‚£ä¹ˆä»–å¯ä»¥å‘é€å¦‚ä¸‹çš„è¯·æ±‚ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_GLOBAL_REQUEST
      string    "tcpip-forward"
      boolean   want reply
      string    address to bind (e.g., "0.0.0.0")
      uint32    port number to bind
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">address to bind</code>å’Œ<code class="language-plaintext highlighter-rouge">port number to bind</code>ç”¨æ¥æ ‡æ˜å“ªä¸ªå…·ä½“çš„IPåœ°å€ï¼ˆæˆ–åŸŸåï¼‰å’Œç«¯å£ç”¨äºè½¬å‘ï¼ˆå¦ä¸€ç«¯ç«¯å¼€å¯å¯¹å“ªä¸ªIPå’Œç«¯å£çš„ç›‘å¬å¹¶è½¬å‘åˆ°æœ¬åœ°ï¼‰ï¼Œ<code class="language-plaintext highlighter-rouge">address to bind</code>æ»¡è¶³ä»¥ä¸‹çš„è¯­æ³•è§„åˆ™ã€‚</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">""</code>è¡¨ç¤ºæ¥å—æ‰€æœ‰çš„è¢«SSHå®ç°æ–¹æ”¯æŒçš„åè®®ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">"0.0.0.0"</code>è¡¨ç¤ºç›‘å¬æ‰€æœ‰IPv4ç«¯å£ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">"::"</code>è¡¨ç¤ºç›‘å¬æ‰€æœ‰IPv6ç«¯å£ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">"localhost"</code>è¡¨ç¤ºåœ¨å›ç¯ç½‘å¡ä¸Šç›‘å¬æ‰€æœ‰è¢«SSHå®ç°æ”¯æŒçš„åè®®ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">"127.0.0.1"</code>å’Œ<code class="language-plaintext highlighter-rouge">"::1"</code>åˆ†åˆ«è¡¨ç¤ºç›‘å¬IPv4å’ŒIPv6çš„å›ç¯ç½‘å¡ã€‚</li>
</ul>

<p>å®¢æˆ·ç«¯åº”è¯¥æ‹’ç»è¿™ä¸ªæ¶ˆæ¯ï¼Œè¿™ä¸ªæ¶ˆæ¯ä¸€èˆ¬åªå…è®¸å®¢æˆ·ç«¯å‘é€ã€‚åŒæ—¶å¦‚æœå®¢æˆ·ç«¯ä¼ é€’çš„<code class="language-plaintext highlighter-rouge">port number</code>æ˜¯0ï¼Œä¸”å®ƒè®¾ç½®äº†<code class="language-plaintext highlighter-rouge">want reply</code>ä¸ºTRUEï¼Œé‚£ä¹ˆæœåŠ¡å™¨åº”è¯¥åˆ†é…ä¸‹ä¸€ä¸ªå¯ç”¨çš„<code class="language-plaintext highlighter-rouge">éæƒé™ç«¯å£</code>ï¼Œå¹¶ä¸”åœ¨å“åº”ä¸­å‘ŠçŸ¥å®¢æˆ·ç«¯ã€‚</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte     SSH_MSG_REQUEST_SUCCESS
      uint32   port that was bound on the server
</code></pre></div></div>
<p>ç«¯å£è½¬å‘å¯ä»¥è¢«ä¸‹é¢çš„æ¶ˆæ¯å–æ¶ˆï¼Œä¸€ä¸ªchannel openè¯·æ±‚å¯èƒ½ä¼šç›´åˆ°æ¥æ”¶åˆ°è¯¥æ¶ˆæ¯çš„å“åº”åæ”¶åˆ°ã€‚è¿™ä¸ªæ¶ˆæ¯åªæœ‰å®¢æˆ·ç«¯å¯ä»¥å‘é€ã€‚</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_GLOBAL_REQUEST
      string    "cancel-tcpip-forward"
      boolean   want reply
      string    address_to_bind (e.g., "127.0.0.1")
      uint32    port number to bind
</code></pre></div></div>

<h3 id="tcpipè½¬å‘channel">TCP/IPè½¬å‘Channel</h3>

<p>å½“æœåŠ¡ç«¯è¢«è®¾ç½®éœ€è¦ç›‘å¬å¹¶è½¬å‘çš„ç«¯å£æ”¶åˆ°äº†å¤–éƒ¨çš„è¿æ¥æ—¶ï¼ŒæœåŠ¡ç«¯å°†å‘é€ä¸‹é¢çš„æ¶ˆæ¯è¯·æ±‚å®¢æˆ·ç«¯å¼€å¯ä¸€ä¸ªTCP/IPè½¬å‘Channelã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_CHANNEL_OPEN
      string    "forwarded-tcpip"
      uint32    sender channel
      uint32    initial window size
      uint32    maximum packet size
      string    address that was connected ï¼ˆå¤–éƒ¨è¿æ¥åˆ°æœåŠ¡å™¨ç›‘å¬åœ°å€çš„çš„IPåœ°å€ï¼‰
      uint32    port that was connected 
      string    originator IP address (è¿™ä¸ªåº”è¯¥æ˜¯æœåŠ¡ç«¯ç›‘å¬çš„åœ°å€)
      uint32    originator port
</code></pre></div></div>
<p>å®¢æˆ·ç«¯åº”è¯¥æ¯”å¯¹æ˜¯å¦å‘æœåŠ¡å™¨è¯·æ±‚äº†originator portçš„TCP/IPç«¯å£è½¬å‘ã€‚</p>

<p>å½“å®¢æˆ·ç«¯æœ¬åœ°çš„TCP/IPè½¬å‘ç«¯å£æ¥æ”¶åˆ°æ¥è‡ªå¤–éƒ¨çš„è¿æ¥ï¼ˆè¿™ä¸ªç›‘å¬ç«¯å£æ˜¯å®¢æˆ·ç«¯ä¸»åŠ¨æ‰“å¼€çš„ï¼‰æ—¶ï¼Œå®¢æˆ·ç«¯å‘é€å¦‚ä¸‹æ¶ˆæ¯ç»™æœåŠ¡å™¨è½¬å‘è¿™ä¸ªTCP/IPæ•°æ®ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      byte      SSH_MSG_CHANNEL_OPEN
      string    "direct-tcpip"
      uint32    sender channel
      uint32    initial window size
      uint32    maximum packet size
      string    host to connect
      uint32    port to connect
      string    originator IP address
      uint32    originator port
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">host to connect</code>å’Œ<code class="language-plaintext highlighter-rouge">port to connect</code>è¡¨ç¤ºæœåŠ¡ç«¯å†…éƒ¨éœ€è¦å»ºç«‹ä¸€ä¸ªé€šå¾€<code class="language-plaintext highlighter-rouge">host to connect</code>ã€<code class="language-plaintext highlighter-rouge">port to connect</code>çš„è¿æ¥ã€‚<code class="language-plaintext highlighter-rouge">originator IP address</code>è¡¨ç¤ºå®¢æˆ·ç«¯ç›‘å¬åˆ°çš„è¿æ¥å‘èµ·äºå“ªä¸ªå¤–éƒ¨IPåœ°å€ã€<code class="language-plaintext highlighter-rouge">originator port</code>è¡¨ç¤ºå®¢æˆ·ç«¯ç›‘å¬åˆ°çš„è¿æ¥å‘èµ·äºå“ªä¸ªå¤–éƒ¨ä¸»æœºçš„ç«¯å£ã€‚</p>

<p>è½¬å‘Channelç‹¬ç«‹äºSessionå­˜åœ¨ï¼ŒSessionå…³é—­å¹¶ä¸æ„å‘³ç€è½¬å‘Channelä¹Ÿè¦è¢«å…³é—­ã€‚å®¢æˆ·ç«¯åº”è¯¥æ‹’ç»<code class="language-plaintext highlighter-rouge">direct-tcpip</code>è¯·æ±‚ã€‚</p>

<h2 id="ç»ˆç«¯æ¨¡å¼çš„ç¼–ç ">ç»ˆç«¯æ¨¡å¼çš„ç¼–ç </h2>

<p>åœ¨è¯·æ±‚ä¸€ä¸ªç»ˆç«¯çš„æ—¶å€™ä¼šç”¨åˆ°ç»ˆç«¯æ¨¡å¼çš„ç¼–ç ï¼ˆ<code class="language-plaintext highlighter-rouge">encoded terminal modes</code>ï¼‰ï¼Œå®ƒä»¬è¢«ç¼–ç è¿›å­—èŠ‚æµé‡Œã€‚è¿™æ˜¯ä¸ºäº†ä»–ä»¬å¯ä»¥æ–¹ä¾¿åœ°åœ¨ä¸åŒç¯å¢ƒé—´ä¼ è¾“ã€‚å­—èŠ‚æµåŒ…æ‹¬ä»¥å­—èŠ‚ä¸ºå€¼åœ°æ“ä½œç æ„æˆåœ°å‚æ•°å¯¹ã€‚1-159çš„æ“ä½œç æ—¶uint32ç±»å‹çš„å‚æ•°ï¼Œ160-255è¿˜æœªè¢«å®šä¹‰ï¼Œå¹¶ä¸”å¦‚æœé‡åˆ°å®ƒä»¬åº”è¯¥åœæ­¢è§£æã€‚å­—èŠ‚æµè¢«æ“ä½œç <code class="language-plaintext highlighter-rouge">TTY_OP_END(0x00)</code>ç»ˆæ­¢ã€‚</p>

<p>å®¢æˆ·ç«¯åº”è¯¥å°½å¯èƒ½çš„æŠŠå®ƒçŸ¥é“çš„æ¨¡å¼æ“ä½œç åŠ å…¥å­—èŠ‚æµä¸­ï¼Œè€ŒæœåŠ¡å™¨å¯¹äºå®ƒä¸çŸ¥é“çš„æ¨¡å¼åº”è¯¥å¿½ç•¥ã€‚è‡³å°‘åœ¨ç”¨ç±»POSIX è™šæ‹Ÿç»ˆç«¯çš„ç³»ç»Ÿé—´ï¼Œä¼šæ”¯æŒä¸€äº›æœºå™¨æ— å…³çš„ç‰¹æ€§ã€‚è¿™ä¸ªåè®®ä¹Ÿèƒ½æ”¯æŒå…¶ä»–çš„ç³»ç»Ÿï¼Œä½†æ˜¯å®¢æˆ·ç«¯æˆ–è®¸éœ€è¦è¡¥å……ä¸€ç³»åˆ—åˆç†çš„å‚æ•°æ•°å€¼è¿™æ ·æœåŠ¡å™¨æ‰èƒ½ä¸ºä¼ªç»ˆç«¯æä¾›åˆç†çš„æ¨¡å¼ã€‚å…·ä½“é¢„å®šä¹‰æ•°å€¼å¦‚ä¸‹ï¼ˆä¸ºäº†å¯è¯»æ€§ï¼Œå°†Byteå†™æˆäº†æ•°å­—ï¼‰ï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>          opcode  mnemonic       description
          ------  --------       -----------
          0     TTY_OP_END  Indicates end of options.
          1     VINTR       Interrupt character; 255 if none.  Similarly
                             for the other characters.  Not all of these
                             characters are supported on all systems.
          2     VQUIT       The quit character (sends SIGQUIT signal on
                             POSIX systems).
          3     VERASE      Erase the character to left of the cursor.
          4     VKILL       Kill the current input line.
          5     VEOF        End-of-file character (sends EOF from the
                             terminal).
          6     VEOL        End-of-line character in addition to
                             carriage return and/or linefeed.
          7     VEOL2       Additional end-of-line character.
          8     VSTART      Continues paused output (normally
                             control-Q).
          9     VSTOP       Pauses output (normally control-S).
          10    VSUSP       Suspends the current program.
          11    VDSUSP      Another suspend character.
                    12    VREPRINT    Reprints the current input line.
          13    VWERASE     Erases a word left of cursor.
          14    VLNEXT      Enter the next character typed literally,
                             even if it is a special character
          15    VFLUSH      Character to flush output.
          16    VSWTCH      Switch to a different shell layer.
          17    VSTATUS     Prints system status line (load, command,
                             pid, etc).
          18    VDISCARD    Toggles the flushing of terminal output.
          30    IGNPAR      The ignore parity flag.  The parameter
                             SHOULD be 0 if this flag is FALSE,
                             and 1 if it is TRUE.
          31    PARMRK      Mark parity and framing errors.
          32    INPCK       Enable checking of parity errors.
          33    ISTRIP      Strip 8th bit off characters.
          34    INLCR       Map NL into CR on input.
          35    IGNCR       Ignore CR on input.
          36    ICRNL       Map CR to NL on input.
          37    IUCLC       Translate uppercase characters to
                             lowercase.
          38    IXON        Enable output flow control.
          39    IXANY       Any char will restart after stop.
          40    IXOFF       Enable input flow control.
          41    IMAXBEL     Ring bell on input queue full.
          50    ISIG        Enable signals INTR, QUIT, [D]SUSP.
          51    ICANON      Canonicalize input lines.
          52    XCASE       Enable input and output of uppercase
                             characters by preceding their lowercase
                             equivalents with "\".
          53    ECHO        Enable echoing.
          54    ECHOE       Visually erase chars.
          55    ECHOK       Kill character discards current line.
          56    ECHONL      Echo NL even if ECHO is off.
          57    NOFLSH      Don't flush after interrupt.
          58    TOSTOP      Stop background jobs from output.
          59    IEXTEN      Enable extensions.
          60    ECHOCTL     Echo control characters as ^(Char).
          61    ECHOKE      Visual erase for line kill.
          62    PENDIN      Retype pending input.
          70    OPOST       Enable output processing.
          71    OLCUC       Convert lowercase to uppercase.
          72    ONLCR       Map NL to CR-NL.
          73    OCRNL       Translate carriage return to newline
                             (output).
          74    ONOCR       Translate newline to carriage
                             return-newline (output).
          75    ONLRET      Newline performs a carriage return
                             (output).
          90    CS7         7 bit mode.
          91    CS8         8 bit mode.
          92    PARENB      Parity enable.
          93    PARODD      Odd parity, else even.

          128 TTY_OP_ISPEED  Specifies the input baud rate in
                              bits per second.
          129 TTY_OP_OSPEED  Specifies the output baud rate in
                              bits per second.
</code></pre></div></div>

<h2 id="é¢„å®šä¹‰åç§°">é¢„å®šä¹‰åç§°</h2>

<h3 id="è¿æ¥åè®®channelç±»å‹">è¿æ¥åè®®Channelç±»å‹</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>         Channel type                  Reference
         ------------                  ---------
         session                       [SSH-CONNECT, Section 6.1]
         x11                           [SSH-CONNECT, Section 6.3.2]
         forwarded-tcpip               [SSH-CONNECT, Section 7.2]
         direct-tcpip                  [SSH-CONNECT, Section 7.2]
</code></pre></div></div>

<h3 id="è¿æ¥åè®®å…¨å±€è¯·æ±‚å">è¿æ¥åè®®å…¨å±€è¯·æ±‚å</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>         Request type                  Reference
         ------------                  ---------
         tcpip-forward                 [SSH-CONNECT, Section 7.1]
         cancel-tcpip-forward          [SSH-CONNECT, Section 7.1]
</code></pre></div></div>

<h3 id="è¿æ¥åè®®channelæ˜ç»†è¯·æ±‚å">è¿æ¥åè®®Channelæ˜ç»†è¯·æ±‚å</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>         Request type                  Reference
         ------------                  ---------
         pty-req                       [SSH-CONNECT, Section 6.2]
         x11-req                       [SSH-CONNECT, Section 6.3.1]
         env                           [SSH-CONNECT, Section 6.4]
         shell                         [SSH-CONNECT, Section 6.5]
         exec                          [SSH-CONNECT, Section 6.5]
         subsystem                     [SSH-CONNECT, Section 6.5]
         window-change                 [SSH-CONNECT, Section 6.7]
         xon-xoff                      [SSH-CONNECT, Section 6.8]
         signal                        [SSH-CONNECT, Section 6.9]
         exit-status                   [SSH-CONNECT, Section 6.10]
         exit-signal                   [SSH-CONNECT, Section 6.10]
</code></pre></div></div>
<h3 id="è¿æ¥åè®®å­ç³»ç»Ÿå">è¿æ¥åè®®å­ç³»ç»Ÿå</h3>

<p>æš‚æ— </p>

<h2 id="reference">Reference</h2>

<ol>
  <li>
    <p><a href="https://www.openssh.com/specs.html">OpenSSH Specifications</a></p>

    <p>è¿™æ˜¯OpenSSHæ‰€å±•ç°çš„æœ€ç›´æ¥çš„èµ„æ–™é¡µé¢ï¼Œä½†æ˜¯æœ‰å¾ˆå¤šç»†èŠ‚éƒ¨åˆ†çš„è§„æ ¼ä¸å®ç°æ²¡æœ‰ç½—åˆ—ã€‚è€Œä¸”RFCæ–‡æ¡£é”™ç»¼å¤æ‚ï¼Œæœ‰å¾ˆå¤šåœ°æ–¹éƒ½å¼•ç”¨ä¸å…¨å¿…é¡»é â€œå¹¸è¿â€æ‰èƒ½ç¿»çœ‹åˆ°ã€‚</p>
  </li>
  <li>
    <p><a href="https://tools.ietf.org/html/rfc4251">The Secure Shell (SSH) Protocol Architecture</a></p>

    <p>SSHåè®®æ¶æ„çš„rfcé¡µé¢ï¼Œå®ƒå°†SSHåˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼Œä¼ è¾“ã€è®¤è¯å’Œè¿æ¥ã€‚</p>
  </li>
  <li>
    <p><a href="https://tools.ietf.org/html/rfc4250">The Secure Shell (SSH) Protocol Assigned Numbers</a></p>

    <p>è§„å®šåè®®ä¸­å„ç§IDï¼ˆå®ï¼‰æ‰€ä½¿ç”¨çš„åºå·ã€‚</p>
  </li>
  <li>
    <p><a href="https://tools.ietf.org/html/rfc4254">The Secure Shell (SSH) Connection Protocol</a></p>

    <p>è§„å®šSSHè¿æ¥åè®®ã€‚</p>
  </li>
  <li>
    <p><a href="https://github.com/openssh/openssh-portable">OpenSSH Portable</a></p>

    <p>OpenSSHçš„æºç ã€‚</p>
  </li>
</ol>
:ET